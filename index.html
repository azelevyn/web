<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>USDT Seller Mini App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bybit-bg: #101010;
            --bybit-secondary-bg: #181A20;
            --bybit-border: #252830;
            --bybit-text: #EAECEF;
            --bybit-text-secondary: #8A919E;
            --bybit-accent: #F7A600;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--bybit-text);
            background-color: var(--bybit-bg);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .chat-window::-webkit-scrollbar { width: 4px; }
        .chat-window::-webkit-scrollbar-track { background: transparent; }
        .chat-window::-webkit-scrollbar-thumb { background: var(--bybit-border); border-radius: 2px; }
        
        .chat-bubble {
            max-width: 85%;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .action-button {
            transition: all 0.2s ease;
            background-color: var(--bybit-accent);
            color: var(--bybit-bg);
            font-weight: 600;
        }
        .action-button:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        
        .bot-bubble {
             background-color: var(--bybit-secondary-bg);
        }

        .user-bubble {
            background: linear-gradient(90deg, #3390ec, #2d70b8);
            color: #ffffff;
        }

        .input-area {
            background-color: var(--bybit-secondary-bg);
            border-top: 1px solid var(--bybit-border);
        }
        .text-input {
            background-color: var(--bybit-bg);
            border: 1px solid var(--bybit-border);
            color: var(--bybit-text);
        }
        .text-input::placeholder {
            color: var(--bybit-text-secondary);
        }
        .text-input:focus {
            outline: none;
            border-color: var(--bybit-accent);
            box-shadow: 0 0 0 2px rgba(247, 166, 0, 0.2);
        }
    </style>
</head>
<body class="flex items-center justify-center h-screen">
    <div class="w-full h-full flex flex-col bg-bybit-bg">
        <!-- Header -->
        <div class="p-3 text-center border-b border-bybit-border">
            <h1 class="text-base font-semibold text-bybit-text">USDT Exchange</h1>
        </div>
        
        <!-- Chat Window -->
        <div id="chat-window" class="flex-1 p-3 space-y-3 overflow-y-auto">
            <!-- Messages will be appended here -->
        </div>

        <!-- Input Area -->
        <div id="input-area" class="p-3 input-area">
            <!-- Buttons and input fields will appear here -->
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); 
        tg.setHeaderColor('#101010');
        tg.setBackgroundColor('#101010');


        const chatWindow = document.getElementById('chat-window');
        const inputArea = document.getElementById('input-area');

        // --- CONSTANTS AND CONFIGURATION ---
        const MIN_USDT = 25;
        const MAX_USDT = 50000;
        const SUPPORT_CONTACT = '@YourSupportUsername';

        const RATES = {
            USDT_TO_USD: 1 / 1.08,
            USD_TO_EUR: 0.89,
            USDT_TO_GBP: 0.77,
        };

        let userState = {};
        
        // --- Haptic Feedback Helper ---
        const triggerHaptic = (style = 'light') => {
            try {
                tg.HapticFeedback.impactOccurred(style);
            } catch (e) {
                console.warn("Haptic feedback is not available.");
            }
        };

        // --- HELPER FUNCTIONS ---
        const scrollToBottom = () => {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        const addBotMessage = (htmlContent, buttons = []) => {
            const botMessage = `
                <div class="flex justify-start chat-bubble">
                    <div class="bot-bubble rounded-lg p-2.5">
                        <div class="text-sm text-bybit-text">${htmlContent}</div>
                    </div>
                </div>
            `;
            chatWindow.insertAdjacentHTML('beforeend', botMessage);
            renderButtons(buttons);
            scrollToBottom();
        };

        const addUserMessage = (text) => {
            const userMessage = `
                <div class="flex justify-end chat-bubble">
                    <div class="user-bubble rounded-lg p-2.5">
                        <p class="text-sm">${text}</p>
                    </div>
                </div>
            `;
            chatWindow.insertAdjacentHTML('beforeend', userMessage);
            scrollToBottom();
        };
        
        const renderButtons = (buttons) => {
            inputArea.innerHTML = '';
            if (buttons.length > 0) {
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'grid grid-cols-2 gap-2';
                buttons.forEach(btn => {
                    const button = document.createElement('button');
                    button.textContent = btn.text;
                    button.className = 'rounded-md p-3 text-sm action-button';
                    button.onclick = () => {
                        triggerHaptic();
                        btn.handler();
                    };
                    buttonContainer.appendChild(button);
                });
                inputArea.appendChild(buttonContainer);
            }
        };

        const renderInput = (placeholder, buttonText, handler, inputType = 'text') => {
             inputArea.innerHTML = `
                <div class="flex gap-2">
                    <input id="text-input" type="${inputType}" placeholder="${placeholder}" class="flex-1 text-input rounded-md p-3 text-sm">
                    <button id="send-button" class="action-button rounded-md px-5 text-sm">${buttonText}</button>
                </div>
            `;
            const inputField = document.getElementById('text-input');
            const sendButton = document.getElementById('send-button');

            const submitHandler = () => {
                if (inputField.value) {
                    triggerHaptic();
                    handler(inputField.value);
                }
            };
            
            sendButton.onclick = submitHandler;
            inputField.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitHandler();
                }
            });
            inputField.focus();
        };
        
        const calculateFiat = (usdtAmount, fiatCurrency) => {
            if (fiatCurrency === 'USD') return usdtAmount * RATES.USDT_TO_USD;
            if (fiatCurrency === 'EUR') return (usdtAmount * RATES.USDT_TO_USD) * RATES.USD_TO_EUR;
            if (fiatCurrency === 'GBP') return usdtAmount * RATES.USDT_TO_GBP;
            return 0;
        };

        // --- CONVERSATION FLOW ---
        const start = () => {
            chatWindow.innerHTML = '';
            userState = {};
            const userName = tg.initDataUnsafe?.user?.first_name || 'Voyager';
            
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', timeZone: 'Asia/Kuala_Lumpur', hour12: false };
            const formattedDate = new Intl.DateTimeFormat('en-GB', options).format(now);

            const welcomeHtml = `‚ú® Hello, <strong>${userName}</strong>! Welcome.<br><br>` +
            `Seamlessly convert your USDT into fiat.<br><br>` +
            `<strong class="text-xs text-bybit-text-secondary">${formattedDate} (MYT)</strong>`;
            
            addBotMessage(welcomeHtml, [
                { text: 'üöÄ Sell USDT', handler: selectCurrency },
                { text: '‚ùì FAQ / Help', handler: showHelp }
            ]);
        };
        
        const showHelp = () => {
             addUserMessage("FAQ / Help");
             const helpHtml = `
                <strong>How to Use (FAQ)</strong><br><br>
                <strong>1. Start:</strong> Tap 'Sell USDT' & choose your currency.<br><br>
                <strong>2. Network:</strong> Pick the correct network (e.g., TRC20). ‚ö†Ô∏è Using the wrong one will lose funds.<br><br>
                <strong>3. Details:</strong> Enter sell amount & payout info.<br><br>
                <strong>4. Deposit:</strong> Scan QR or copy address to send the exact USDT amount.<br><br>
                <strong>Support:</strong> ${SUPPORT_CONTACT}.
            `;
            addBotMessage(helpHtml, [
                { text: '‚¨ÖÔ∏è Back', handler: start }
            ]);
        };

        const selectCurrency = () => {
            addUserMessage("Sell USDT");
            const ratesHtml = `<strong>Current Rates:</strong><br>`+
                `- 1 USDT ‚âà ${RATES.USDT_TO_USD.toFixed(3)} USD<br>`+
                `- 1 USDT ‚âà ${(RATES.USDT_TO_USD * RATES.USD_TO_EUR).toFixed(3)} EUR<br>`+
                `- 1 USDT ‚âà ${RATES.USDT_TO_GBP.toFixed(3)} GBP<br><br>`+
                `Select receiving currency:`;
            
            addBotMessage(ratesHtml, [
                { text: 'üá∫üá∏ USD', handler: () => selectNetwork('USD') },
                { text: 'üá™üá∫ EUR', handler: () => selectNetwork('EUR') },
                { text: 'üá¨üáß GBP', handler: () => selectNetwork('GBP') }
            ]);
        };

        const selectNetwork = (fiat) => {
            addUserMessage(fiat);
            userState.fiat = fiat;
            addBotMessage('Select network for deposit:', [
                { text: 'TRC20 (Tron)', handler: () => promptForAmount('TRC20') },
                { text: 'ERC20 (Ethereum)', handler: () => promptForAmount('ERC20') }
            ]);
        };

        const promptForAmount = (network) => {
            addUserMessage(network);
            userState.network = network;
            const promptHtml = `Enter USDT amount to sell.<br><br><strong>Min:</strong> ${MIN_USDT} / <strong>Max:</strong> ${MAX_USDT}`;
            addBotMessage(promptHtml);
            renderInput(`e.g., 100`, 'Next', handleAmountInput, 'number');
        };
        
        const handleAmountInput = (amountStr) => {
            const amount = parseFloat(amountStr);
            if (isNaN(amount) || amount < MIN_USDT || amount > MAX_USDT) {
                addBotMessage(`‚ùå Invalid amount. Must be between ${MIN_USDT} and ${MAX_USDT}.`);
                renderInput(`e.g., 100`, 'Next', handleAmountInput, 'number');
                return;
            }
            addUserMessage(`${amount} USDT`);
            userState.amount = amount;
            const fiatToReceive = calculateFiat(amount, userState.fiat);
            const confirmationHtml = `You'll get ‚âà <strong>${fiatToReceive.toFixed(2)} ${userState.fiat}</strong>.<br><br>Choose payout method:`;
            
            addBotMessage(confirmationHtml, [
                { text: "Wise", handler: () => promptForDetails('wise') }, 
                { text: "Revolut", handler: () => promptForDetails('revolut') },
                { text: "PayPal", handler: () => promptForDetails('paypal') }, 
                { text: "Bank", handler: handleBankTransfer },
                { text: "Skrill/Neteller", handler: handleSkrillNeteller }, 
                { text: "Card", handler: () => promptForDetails('card') },
                { text: "Payeer", handler: () => promptForDetails('payeer') }, 
                { text: "Alipay", handler: () => promptForDetails('alipay') }
            ]);
        };
        
        const handleSkrillNeteller = () => {
            addUserMessage("Skrill/Neteller");
            addBotMessage("Select service:", [
                { text: "Skrill", handler: () => promptForDetails('skrill') },
                { text: "Neteller", handler: () => promptForDetails('neteller') }
            ]);
        };
        
        const handleBankTransfer = () => {
            addUserMessage("Bank");
            addBotMessage("Select bank region:", [
                { text: "üá™üá∫ European", handler: () => promptForDetails('bank_eu') },
                { text: "üá∫üá∏ US", handler: () => promptForDetails('bank_us') }
            ]);
        };

        const promptForDetails = (method) => {
            userState.paymentMethod = method;
            let promptHtml = '';
            let placeholder = '';

            switch (method) {
                case 'wise': addUserMessage("Wise"); promptHtml = 'Enter your <strong>Wise email</strong> or <strong>@wisetag</strong>.'; placeholder="email@example.com"; break;
                case 'revolut': addUserMessage("Revolut"); promptHtml = 'Enter your <strong>Revolut tag</strong> (e.g., @username).'; placeholder="@username"; break;
                case 'paypal': addUserMessage("PayPal"); promptHtml = 'Enter your <strong>PayPal email</strong>.'; placeholder="email@paypal.com"; break;
                case 'skrill': addUserMessage("Skrill"); promptHtml = 'Enter your <strong>Skrill email</strong>.'; placeholder="email@skrill.com"; break;
                case 'neteller': addUserMessage("Neteller"); promptHtml = 'Enter your <strong>Neteller email</strong>.'; placeholder="email@neteller.com"; break;
                case 'card': addUserMessage("Card"); promptHtml = 'Enter your <strong>Visa/Mastercard number</strong>.'; placeholder="1234..."; break;
                case 'payeer': addUserMessage("Payeer"); promptHtml = 'Enter your <strong>Payeer Number</strong> (e.g., P12345678).'; placeholder="P12345678"; break;
                case 'alipay': addUserMessage("Alipay"); promptHtml = 'Enter your <strong>Alipay email</strong>.'; placeholder="email@alipay.com"; break;
                case 'bank_eu': addUserMessage("European Bank"); promptHtml = 'Enter details:<br><code>Name:\nIBAN:\nSwift:</code>'; placeholder="John Doe\nDE89...\n..."; break;
                case 'bank_us': addUserMessage("US Bank"); promptHtml = 'Enter details:<br><code>Holder:\nAccount#:\nRouting#:</code>'; placeholder="John Doe\n123456789\n..."; break;
            }
            addBotMessage(promptHtml);
            renderInput(placeholder, 'Submit', (details) => generateDeposit(details));
        };

        const generateDeposit = async (details) => {
            addUserMessage("Details submitted.");
            userState.paymentDetails = details;
            
            addBotMessage("‚è≥ Generating secure deposit address...");
            inputArea.innerHTML = `<div class="text-center text-sm text-bybit-text-secondary">Processing...</div>`;

            try {
                // IMPORTANT: In a real deployment, change 'localhost' to your public server address
                const response = await fetch('http://localhost:3000/api/create-transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userState),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create transaction.');
                }

                const result = await response.json();
                
                const qr = qrcode(0, 'M');
                qr.addData(result.address);
                qr.make();
                const qrCodeDataUrl = qr.createDataURL(4, 4);

                const depositHtml = `
                    ‚úÖ <strong>Deposit Address Generated</strong><br><br>
                    <div class="flex items-center justify-center p-2 bg-white rounded-lg my-2 mx-auto w-36 h-36">
                        <img src="${qrCodeDataUrl}" alt="QR Code" class="w-full h-full">
                    </div>
                    Send exactly <strong>${result.amount} USDT</strong> (${userState.network}) to this address:<br><br>
                    <div class="bot-bubble p-2.5 rounded-lg text-center font-mono break-all text-xs my-2">
                        <code>${result.address}</code>
                    </div>
                    <a href="${result.status_url}" target="_blank" style="color: var(--bybit-accent);">Click to track transaction status</a><br><br>
                    <span class="text-bybit-text-secondary">‚ö†Ô∏è Send only ${userState.network} USDT.</span>
                `;

                addBotMessage(depositHtml, [
                    { text: 'üéâ New Transaction', handler: start }
                ]);

            } catch (error) {
                let userFriendlyError = error.message.includes('Failed to fetch') 
                    ? `<strong>Connection Error:</strong> Could not connect to the backend server. Please ensure it's running.`
                    : `<strong>An error occurred:</strong> ${error.message}`;

                addBotMessage(`‚ùå ${userFriendlyError}`, [ { text: '‚¨ÖÔ∏è Start Over', handler: start } ]);
            }
        };

        // Initialize the app
        tg.ready();
        start();
    </script>
</body>
</html>

